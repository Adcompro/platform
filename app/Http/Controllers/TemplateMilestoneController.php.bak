<?php

namespace App\Http\Controllers;

use App\Models\ProjectTemplate;
use App\Models\TemplateMilestone;
use Illuminate\Http\Request;
use Illuminate\Http\RedirectResponse;
use Illuminate\View\View;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Auth;

class TemplateMilestoneController extends Controller
{
    /**
     * Display milestones for a specific template
     */
    public function index(ProjectTemplate $projectTemplate): View
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $milestones = $projectTemplate->milestones()
            ->with(['tasks.subtasks'])
            ->orderBy('sort_order')
            ->orderBy('created_at')
            ->get();

        return view('templates.projects.milestones.index', compact('projectTemplate', 'milestones'));
    }

    /**
     * Show the form for creating a new milestone
     */
    public function create(ProjectTemplate $projectTemplate): View
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only add milestones to templates from your own company.');
        }

        return view('templates.projects.milestones.create', compact('projectTemplate'));
    }

    /**
     * Store a newly created milestone
     */
    public function store(Request $request, ProjectTemplate $projectTemplate): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only add milestones to templates from your own company.');
        }

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'description' => 'nullable|string',
            'estimated_hours' => 'nullable|numeric|min:0',
            'hourly_rate' => 'nullable|numeric|min:0',
            'fee_type' => 'required|in:in_fee,additional',
            'days_from_start' => 'nullable|integer|min:0',
            'duration_days' => 'nullable|integer|min:1',
            'default_start_date' => 'nullable|date',
            'default_end_date' => 'nullable|date|after_or_equal:default_start_date'
        ]);

        // Calculate sort order
        $maxSortOrder = $projectTemplate->milestones()->max('sort_order') ?? 0;
        $validated['sort_order'] = $maxSortOrder + 1;

        $milestone = $projectTemplate->milestones()->create($validated);

        return redirect()->route('project-templates.milestones.show', [$projectTemplate, $milestone])
            ->with('success', 'Template milestone created successfully!');
    }

    /**
     * Display the specified milestone
     */
    public function show(ProjectTemplate $projectTemplate, TemplateMilestone $milestone): View
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $milestone->load(['tasks.subtasks']);

        // Calculate milestone statistics
        $stats = [
            'total_tasks' => $milestone->tasks()->count(),
            'total_subtasks' => $milestone->tasks()->withCount('subtasks')->get()->sum('subtasks_count'),
            'total_estimated_hours' => $milestone->estimated_hours + $milestone->tasks()->sum('estimated_hours'),
            'usage_count' => $this->getMilestoneUsageCount($milestone)
        ];

        return view('templates.projects.milestones.show', compact('projectTemplate', 'milestone', 'stats'));
    }

    /**
     * Show the form for editing the specified milestone
     */
    public function edit(ProjectTemplate $projectTemplate, TemplateMilestone $milestone): View
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only edit milestones from templates in your own company.');
        }

        return view('templates.projects.milestones.edit', compact('projectTemplate', 'milestone'));
    }

    /**
     * Update the specified milestone
     */
    public function update(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only edit milestones from templates in your own company.');
        }

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'description' => 'nullable|string',
            'estimated_hours' => 'nullable|numeric|min:0',
            'hourly_rate' => 'nullable|numeric|min:0',
            'fee_type' => 'required|in:in_fee,additional',
            'days_from_start' => 'nullable|integer|min:0',
            'duration_days' => 'nullable|integer|min:1',
            'default_start_date' => 'nullable|date',
            'default_end_date' => 'nullable|date|after_or_equal:default_start_date'
        ]);

        $milestone->update($validated);

        return redirect()->route('project-templates.milestones.show', [$projectTemplate, $milestone])
            ->with('success', 'Template milestone updated successfully!');
    }

    /**
     * Remove the specified milestone
     */
    public function destroy(ProjectTemplate $projectTemplate, TemplateMilestone $milestone): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only delete milestones from templates in your own company.');
        }

        try {
            $milestone->delete();
            
            return redirect()->route('project-templates.milestones.index', $projectTemplate)
                ->with('success', 'Template milestone deleted successfully!');
                
        } catch (\Exception $e) {
            return redirect()->back()
                ->with('error', 'Error deleting milestone: ' . $e->getMessage());
        }
    }

    /**
     * Reorder milestones via drag & drop
     */
    public function reorder(Request $request, ProjectTemplate $projectTemplate): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only reorder milestones in templates from your own company.');
        }

        $validated = $request->validate([
            'milestone_ids' => 'required|array',
            'milestone_ids.*' => 'exists:template_milestones,id'
        ]);

        foreach ($validated['milestone_ids'] as $index => $milestoneId) {
            TemplateMilestone::where('id', $milestoneId)
                ->where('template_id', $projectTemplate->id)
                ->update(['sort_order' => $index + 1]);
        }

        return response()->json([
            'success' => true,
            'message' => 'Milestones reordered successfully!'
        ]);
    }

    /**
     * Duplicate a milestone
     */
    public function duplicate(ProjectTemplate $projectTemplate, TemplateMilestone $milestone): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only duplicate milestones from templates in your own company.');
        }

        try {
            $newMilestone = $milestone->replicate();
            $newMilestone->name = $milestone->name . ' (Copy)';
            $newMilestone->sort_order = ($projectTemplate->milestones()->max('sort_order') ?? 0) + 1;
            $newMilestone->save();

            // Duplicate tasks and subtasks
            foreach ($milestone->tasks as $task) {
                $newTask = $task->replicate();
                $newTask->milestone_id = $newMilestone->id;
                $newTask->save();

                foreach ($task->subtasks as $subtask) {
                    $newSubtask = $subtask->replicate();
                    $newSubtask->task_id = $newTask->id;
                    $newSubtask->save();
                }
            }

            return redirect()->route('project-templates.milestones.show', [$projectTemplate, $newMilestone])
                ->with('success', 'Template milestone duplicated successfully!');

        } catch (\Exception $e) {
            return redirect()->back()
                ->with('error', 'Error duplicating milestone: ' . $e->getMessage());
        }
    }

    /**
     * Get milestone data for API/AJAX requests
     */
    public function apiShow(ProjectTemplate $projectTemplate, TemplateMilestone $milestone): JsonResponse
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $milestone->load(['tasks.subtasks']);

        return response()->json([
            'milestone' => $milestone,
            'stats' => [
                'total_tasks' => $milestone->tasks()->count(),
                'total_subtasks' => $milestone->tasks()->withCount('subtasks')->get()->sum('subtasks_count'),
                'total_estimated_hours' => $milestone->estimated_hours + $milestone->tasks()->sum('estimated_hours'),
                'usage_count' => $this->getMilestoneUsageCount($milestone)
            ]
        ]);
    }

    /**
     * Import milestone from another template
     */
    public function import(Request $request, ProjectTemplate $projectTemplate): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only import milestones to templates from your own company.');
        }

        $validated = $request->validate([
            'source_milestone_id' => 'required|exists:template_milestones,id'
        ]);

        try {
            $sourceMilestone = TemplateMilestone::with(['tasks.subtasks'])->findOrFail($validated['source_milestone_id']);
            
            // Check access to source milestone
            if ($sourceMilestone->template->company_id !== Auth::user()->company_id && !$sourceMilestone->template->is_public) {
                abort(403, 'You do not have access to the source milestone.');
            }

            // Create new milestone
            $newMilestone = $sourceMilestone->replicate();
            $newMilestone->template_id = $projectTemplate->id;
            $newMilestone->name = $sourceMilestone->name . ' (Imported)';
            $newMilestone->sort_order = ($projectTemplate->milestones()->max('sort_order') ?? 0) + 1;
            $newMilestone->save();

            // Import tasks and subtasks
            foreach ($sourceMilestone->tasks as $task) {
                $newTask = $task->replicate();
                $newTask->milestone_id = $newMilestone->id;
                $newTask->save();

                foreach ($task->subtasks as $subtask) {
                    $newSubtask = $subtask->replicate();
                    $newSubtask->task_id = $newTask->id;
                    $newSubtask->save();
                }
            }

            return response()->json([
                'success' => true,
                'message' => 'Milestone imported successfully!',
                'milestone' => $newMilestone
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error importing milestone: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get milestones for template builder
     */
    public function getForBuilder(ProjectTemplate $projectTemplate): JsonResponse
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $milestones = $projectTemplate->milestones()
            ->with(['tasks.subtasks'])
            ->orderBy('sort_order')
            ->get()
            ->map(function($milestone) {
                return [
                    'id' => $milestone->id,
                    'name' => $milestone->name,
                    'description' => $milestone->description,
                    'estimated_hours' => $milestone->estimated_hours,
                    'hourly_rate' => $milestone->hourly_rate,
                    'fee_type' => $milestone->fee_type,
                    'days_from_start' => $milestone->days_from_start,
                    'duration_days' => $milestone->duration_days,
                    'sort_order' => $milestone->sort_order,
                    'tasks_count' => $milestone->tasks->count(),
                    'total_hours' => $milestone->estimated_hours + $milestone->tasks->sum('estimated_hours')
                ];
            });

        return response()->json(['milestones' => $milestones]);
    }

    /**
     * Bulk operations on milestones
     */
    public function bulkAction(Request $request, ProjectTemplate $projectTemplate): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only perform bulk actions on templates from your own company.');
        }

        $validated = $request->validate([
            'action' => 'required|in:delete,duplicate,update_fee_type',
            'milestone_ids' => 'required|array',
            'milestone_ids.*' => 'exists:template_milestones,id',
            'fee_type' => 'required_if:action,update_fee_type|in:in_fee,additional'
        ]);

        $milestones = TemplateMilestone::whereIn('id', $validated['milestone_ids'])
            ->where('template_id', $projectTemplate->id)
            ->get();

        $processedCount = 0;

        try {
            switch ($validated['action']) {
                case 'delete':
                    foreach ($milestones as $milestone) {
                        $milestone->delete();
                        $processedCount++;
                    }
                    break;

                case 'duplicate':
                    foreach ($milestones as $milestone) {
                        $newMilestone = $milestone->replicate();
                        $newMilestone->name = $milestone->name . ' (Copy)';
                        $newMilestone->sort_order = ($projectTemplate->milestones()->max('sort_order') ?? 0) + 1;
                        $newMilestone->save();

                        // Duplicate tasks and subtasks
                        foreach ($milestone->tasks as $task) {
                            $newTask = $task->replicate();
                            $newTask->milestone_id = $newMilestone->id;
                            $newTask->save();

                            foreach ($task->subtasks as $subtask) {
                                $newSubtask = $subtask->replicate();
                                $newSubtask->task_id = $newTask->id;
                                $newSubtask->save();
                            }
                        }
                        $processedCount++;
                    }
                    break;

                case 'update_fee_type':
                    foreach ($milestones as $milestone) {
                        $milestone->update(['fee_type' => $validated['fee_type']]);
                        $processedCount++;
                    }
                    break;
            }

            return response()->json([
                'success' => true,
                'message' => "Successfully processed {$processedCount} milestones",
                'processed_count' => $processedCount
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error processing bulk action: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get milestone usage statistics
     */
    private function getMilestoneUsageCount(TemplateMilestone $milestone): int
    {
        // Count how many times this milestone type appears in actual projects
        // This would need to be implemented based on how template import works
        // For now, return 0 as placeholder
        return 0;
    }

    /**
     * Export milestone data
     */
    public function export(ProjectTemplate $projectTemplate, TemplateMilestone $milestone): JsonResponse
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $milestone->load(['tasks.subtasks']);

        $exportData = [
            'milestone' => $milestone->toArray(),
            'tasks' => $milestone->tasks->toArray(),
            'exported_at' => now(),
            'exported_by' => Auth::user()->name
        ];

        return response()->json($exportData)
            ->header('Content-Disposition', 'attachment; filename="milestone_' . $milestone->id . '_export.json"');
    }
}