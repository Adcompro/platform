<?php

namespace App\Http\Controllers;

use App\Models\ProjectTemplate;
use App\Models\TemplateMilestone;
use App\Models\TemplateTask;
use App\Models\TemplateSubtask;
use Illuminate\Http\Request;
use Illuminate\Http\RedirectResponse;
use Illuminate\View\View;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Auth;

class TemplateSubtaskController extends Controller
{
    /**
     * Display subtasks for a specific task
     */
    public function index(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): View
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $subtasks = $task->subtasks()
            ->orderBy('sort_order')
            ->orderBy('created_at')
            ->get();

        return view('templates.projects.milestones.tasks.subtasks.index', compact('projectTemplate', 'milestone', 'task', 'subtasks'));
    }

    /**
     * Show the form for creating a new subtask
     */
    public function create(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): View
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only add subtasks to templates from your own company.');
        }

        return view('templates.projects.milestones.tasks.subtasks.create', compact('projectTemplate', 'milestone', 'task'));
    }

    /**
     * Store a newly created subtask
     */
    public function store(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only add subtasks to templates from your own company.');
        }

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'description' => 'nullable|string',
            'estimated_hours' => 'nullable|numeric|min:0',
            'hourly_rate' => 'nullable|numeric|min:0',
            'fee_type' => 'required|in:in_fee,additional'
        ]);

        // Calculate sort order
        $maxSortOrder = $task->subtasks()->max('sort_order') ?? 0;
        $validated['sort_order'] = $maxSortOrder + 1;

        $subtask = $task->subtasks()->create($validated);

        return redirect()->route('project-templates.milestones.tasks.subtasks.show', [$projectTemplate, $milestone, $task, $subtask])
            ->with('success', 'Template subtask created successfully!');
    }

    /**
     * Display the specified subtask
     */
    public function show(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task, TemplateSubtask $subtask): View
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        // Calculate subtask statistics
        $stats = [
            'effective_rate' => $this->getEffectiveRate($subtask),
            'usage_count' => $this->getSubtaskUsageCount($subtask)
        ];

        return view('templates.projects.milestones.tasks.subtasks.show', compact('projectTemplate', 'milestone', 'task', 'subtask', 'stats'));
    }

    /**
     * Show the form for editing the specified subtask
     */
    public function edit(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task, TemplateSubtask $subtask): View
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only edit subtasks from templates in your own company.');
        }

        return view('templates.projects.milestones.tasks.subtasks.edit', compact('projectTemplate', 'milestone', 'task', 'subtask'));
    }

    /**
     * Update the specified subtask
     */
    public function update(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task, TemplateSubtask $subtask): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only edit subtasks from templates in your own company.');
        }

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'description' => 'nullable|string',
            'estimated_hours' => 'nullable|numeric|min:0',
            'hourly_rate' => 'nullable|numeric|min:0',
            'fee_type' => 'required|in:in_fee,additional'
        ]);

        $subtask->update($validated);

        return redirect()->route('project-templates.milestones.tasks.subtasks.show', [$projectTemplate, $milestone, $task, $subtask])
            ->with('success', 'Template subtask updated successfully!');
    }

    /**
     * Remove the specified subtask
     */
    public function destroy(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task, TemplateSubtask $subtask): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only delete subtasks from templates in your own company.');
        }

        try {
            $subtask->delete();
            
            return redirect()->route('project-templates.milestones.tasks.subtasks.index', [$projectTemplate, $milestone, $task])
                ->with('success', 'Template subtask deleted successfully!');
                
        } catch (\Exception $e) {
            return redirect()->back()
                ->with('error', 'Error deleting subtask: ' . $e->getMessage());
        }
    }

    /**
     * Reorder subtasks via drag & drop
     */
    public function reorder(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only reorder subtasks in templates from your own company.');
        }

        $validated = $request->validate([
            'subtask_ids' => 'required|array',
            'subtask_ids.*' => 'exists:template_subtasks,id'
        ]);

        foreach ($validated['subtask_ids'] as $index => $subtaskId) {
            TemplateSubtask::where('id', $subtaskId)
                ->where('task_id', $task->id)
                ->update(['sort_order' => $index + 1]);
        }

        return response()->json([
            'success' => true,
            'message' => 'Subtasks reordered successfully!'
        ]);
    }

    /**
     * Duplicate a subtask
     */
    public function duplicate(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task, TemplateSubtask $subtask): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only duplicate subtasks from templates in your own company.');
        }

        try {
            $newSubtask = $subtask->replicate();
            $newSubtask->name = $subtask->name . ' (Copy)';
            $newSubtask->sort_order = ($task->subtasks()->max('sort_order') ?? 0) + 1;
            $newSubtask->save();

            return redirect()->route('project-templates.milestones.tasks.subtasks.show', [$projectTemplate, $milestone, $task, $newSubtask])
                ->with('success', 'Template subtask duplicated successfully!');

        } catch (\Exception $e) {
            return redirect()->back()
                ->with('error', 'Error duplicating subtask: ' . $e->getMessage());
        }
    }

    /**
     * Move subtask to different task
     */
    public function move(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task, TemplateSubtask $subtask): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only move subtasks in templates from your own company.');
        }

        $validated = $request->validate([
            'target_task_id' => 'required|exists:template_tasks,id'
        ]);

        // Verify target task belongs to same template
        $targetTask = TemplateTask::whereHas('milestone', function($q) use ($projectTemplate) {
            $q->where('template_id', $projectTemplate->id);
        })->findOrFail($validated['target_task_id']);

        // Update subtask task and reset sort order
        $maxSortOrder = $targetTask->subtasks()->max('sort_order') ?? 0;
        
        $subtask->update([
            'task_id' => $targetTask->id,
            'sort_order' => $maxSortOrder + 1
        ]);

        return response()->json([
            'success' => true,
            'message' => 'Subtask moved successfully!',
            'subtask' => $subtask->fresh(['task.milestone'])
        ]);
    }

    /**
     * Get subtask data for API/AJAX requests
     */
    public function apiShow(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task, TemplateSubtask $subtask): JsonResponse
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        return response()->json([
            'subtask' => $subtask,
            'stats' => [
                'effective_rate' => $this->getEffectiveRate($subtask),
                'usage_count' => $this->getSubtaskUsageCount($subtask)
            ]
        ]);
    }

    /**
     * Import subtask from another template
     */
    public function import(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only import subtasks to templates from your own company.');
        }

        $validated = $request->validate([
            'source_subtask_id' => 'required|exists:template_subtasks,id'
        ]);

        try {
            $sourceSubtask = TemplateSubtask::with(['task.milestone.template'])->findOrFail($validated['source_subtask_id']);
            
            // Check access to source subtask
            if ($sourceSubtask->task->milestone->template->company_id !== Auth::user()->company_id && !$sourceSubtask->task->milestone->template->is_public) {
                abort(403, 'You do not have access to the source subtask.');
            }

            // Create new subtask
            $newSubtask = $sourceSubtask->replicate();
            $newSubtask->task_id = $task->id;
            $newSubtask->name = $sourceSubtask->name . ' (Imported)';
            $newSubtask->sort_order = ($task->subtasks()->max('sort_order') ?? 0) + 1;
            $newSubtask->save();

            return response()->json([
                'success' => true,
                'message' => 'Subtask imported successfully!',
                'subtask' => $newSubtask
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error importing subtask: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get subtasks for template builder
     */
    public function getForBuilder(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): JsonResponse
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $subtasks = $task->subtasks()
            ->orderBy('sort_order')
            ->get()
            ->map(function($subtask) {
                return [
                    'id' => $subtask->id,
                    'name' => $subtask->name,
                    'description' => $subtask->description,
                    'estimated_hours' => $subtask->estimated_hours,
                    'hourly_rate' => $subtask->hourly_rate,
                    'fee_type' => $subtask->fee_type,
                    'sort_order' => $subtask->sort_order,
                    'effective_rate' => $this->getEffectiveRate($subtask)
                ];
            });

        return response()->json(['subtasks' => $subtasks]);
    }

    /**
     * Bulk operations on subtasks
     */
    public function bulkAction(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only perform bulk actions on templates from your own company.');
        }

        $validated = $request->validate([
            'action' => 'required|in:delete,duplicate,update_fee_type,move',
            'subtask_ids' => 'required|array',
            'subtask_ids.*' => 'exists:template_subtasks,id',
            'fee_type' => 'required_if:action,update_fee_type|in:in_fee,additional',
            'target_task_id' => 'required_if:action,move|exists:template_tasks,id'
        ]);

        $subtasks = TemplateSubtask::whereIn('id', $validated['subtask_ids'])
            ->where('task_id', $task->id)
            ->get();

        $processedCount = 0;

        try {
            switch ($validated['action']) {
                case 'delete':
                    foreach ($subtasks as $subtask) {
                        $subtask->delete();
                        $processedCount++;
                    }
                    break;

                case 'duplicate':
                    foreach ($subtasks as $subtask) {
                        $newSubtask = $subtask->replicate();
                        $newSubtask->name = $subtask->name . ' (Copy)';
                        $newSubtask->sort_order = ($task->subtasks()->max('sort_order') ?? 0) + 1;
                        $newSubtask->save();
                        $processedCount++;
                    }
                    break;

                case 'update_fee_type':
                    foreach ($subtasks as $subtask) {
                        $subtask->update(['fee_type' => $validated['fee_type']]);
                        $processedCount++;
                    }
                    break;

                case 'move':
                    $targetTask = TemplateTask::whereHas('milestone', function($q) use ($projectTemplate) {
                        $q->where('template_id', $projectTemplate->id);
                    })->findOrFail($validated['target_task_id']);

                    $maxSortOrder = $targetTask->subtasks()->max('sort_order') ?? 0;

                    foreach ($subtasks as $subtask) {
                        $subtask->update([
                            'task_id' => $targetTask->id,
                            'sort_order' => ++$maxSortOrder
                        ]);
                        $processedCount++;
                    }
                    break;
            }

            return response()->json([
                'success' => true,
                'message' => "Successfully processed {$processedCount} subtasks",
                'processed_count' => $processedCount
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error processing bulk action: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get effective hourly rate for subtask
     */
    public function getEffectiveRate(TemplateSubtask $subtask): float
    {
        // Priority: Subtask rate > Task rate > Milestone rate > Template default > Company rate
        if ($subtask->hourly_rate) {
            return $subtask->hourly_rate;
        }

        if ($subtask->task->hourly_rate) {
            return $subtask->task->hourly_rate;
        }

        if ($subtask->task->milestone->hourly_rate) {
            return $subtask->task->milestone->hourly_rate;
        }

        if ($subtask->task->milestone->template->hourly_rate) {
            return $subtask->task->milestone->template->hourly_rate;
        }

        return Auth::user()->company->default_hourly_rate ?? 75.00;
    }

    /**
     * Get subtask usage statistics
     */
    private function getSubtaskUsageCount(TemplateSubtask $subtask): int
    {
        // Count how many times this subtask type appears in actual projects
        // This would need to be implemented based on how template import works
        // For now, return 0 as placeholder
        return 0;
    }

    /**
     * Search subtasks across templates
     */
    public function search(Request $request): JsonResponse
    {
        $user = Auth::user();
        $search = $request->input('q', '');
        
        $subtasks = TemplateSubtask::whereHas('task.milestone.template', function($q) use ($user) {
            $q->where('company_id', $user->company_id)
              ->orWhere('is_public', true);
        })
            ->where(function($q) use ($search) {
                $q->where('name', 'like', "%{$search}%")
                  ->orWhere('description', 'like', "%{$search}%");
            })
            ->with(['task.milestone.template'])
            ->orderBy('name')
            ->limit(10)
            ->get();

        return response()->json([
            'subtasks' => $subtasks->map(function($subtask) {
                return [
                    'id' => $subtask->id,
                    'name' => $subtask->name,
                    'description' => $subtask->description,
                    'estimated_hours' => $subtask->estimated_hours,
                    'template_name' => $subtask->task->milestone->template->name,
                    'milestone_name' => $subtask->task->milestone->name,
                    'task_name' => $subtask->task->name
                ];
            })
        ]);
    }

    /**
     * Export subtask data
     */
    public function export(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task, TemplateSubtask $subtask): JsonResponse
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $exportData = [
            'subtask' => $subtask->toArray(),
            'hierarchy' => [
                'template' => $projectTemplate->name,
                'milestone' => $milestone->name,
                'task' => $task->name
            ],
            'exported_at' => now(),
            'exported_by' => Auth::user()->name
        ];

        return response()->json($exportData)
            ->header('Content-Disposition', 'attachment; filename="subtask_' . $subtask->id . '_export.json"');
    }
}