<?php

namespace App\Http\Controllers;

use App\Models\ProjectTemplate;
use App\Models\TemplateMilestone;
use App\Models\TemplateTask;
use Illuminate\Http\Request;
use Illuminate\Http\RedirectResponse;
use Illuminate\View\View;
use Illuminate\Http\JsonResponse;
use Illuminate\Support\Facades\Auth;

class TemplateTaskController extends Controller
{
    /**
     * Display tasks for a specific milestone
     */
    public function index(ProjectTemplate $projectTemplate, TemplateMilestone $milestone): View
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $tasks = $milestone->tasks()
            ->with(['subtasks'])
            ->orderBy('sort_order')
            ->orderBy('created_at')
            ->get();

        return view('templates.projects.milestones.tasks.index', compact('projectTemplate', 'milestone', 'tasks'));
    }

    /**
     * Show the form for creating a new task
     */
    public function create(ProjectTemplate $projectTemplate, TemplateMilestone $milestone): View
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only duplicate tasks from templates in your own company.');
        }

        try {
            $newTask = $task->replicate();
            $newTask->name = $task->name . ' (Copy)';
            $newTask->sort_order = ($milestone->tasks()->max('sort_order') ?? 0) + 1;
            $newTask->save();

            // Duplicate subtasks
            foreach ($task->subtasks as $subtask) {
                $newSubtask = $subtask->replicate();
                $newSubtask->task_id = $newTask->id;
                $newSubtask->save();
            }

            return redirect()->route('project-templates.milestones.tasks.show', [$projectTemplate, $milestone, $newTask])
                ->with('success', 'Template task duplicated successfully!');

        } catch (\Exception $e) {
            return redirect()->back()
                ->with('error', 'Error duplicating task: ' . $e->getMessage());
        }
    }

    /**
     * Move task to different milestone
     */
    public function move(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only move tasks in templates from your own company.');
        }

        $validated = $request->validate([
            'target_milestone_id' => 'required|exists:template_milestones,id'
        ]);

        // Verify target milestone belongs to same template
        $targetMilestone = TemplateMilestone::where('id', $validated['target_milestone_id'])
            ->where('template_id', $projectTemplate->id)
            ->firstOrFail();

        // Update task milestone and reset sort order
        $maxSortOrder = $targetMilestone->tasks()->max('sort_order') ?? 0;
        
        $task->update([
            'milestone_id' => $targetMilestone->id,
            'sort_order' => $maxSortOrder + 1
        ]);

        return response()->json([
            'success' => true,
            'message' => 'Task moved successfully!',
            'task' => $task->fresh(['milestone'])
        ]);
    }

    /**
     * Get task data for API/AJAX requests
     */
    public function apiShow(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): JsonResponse
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $task->load(['subtasks']);

        return response()->json([
            'task' => $task,
            'stats' => [
                'total_subtasks' => $task->subtasks()->count(),
                'total_estimated_hours' => $task->estimated_hours + $task->subtasks()->sum('estimated_hours'),
                'usage_count' => $this->getTaskUsageCount($task)
            ]
        ]);
    }

    /**
     * Import task from another template
     */
    public function import(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only import tasks to templates from your own company.');
        }

        $validated = $request->validate([
            'source_task_id' => 'required|exists:template_tasks,id'
        ]);

        try {
            $sourceTask = TemplateTask::with(['subtasks', 'milestone.template'])->findOrFail($validated['source_task_id']);
            
            // Check access to source task
            if ($sourceTask->milestone->template->company_id !== Auth::user()->company_id && !$sourceTask->milestone->template->is_public) {
                abort(403, 'You do not have access to the source task.');
            }

            // Create new task
            $newTask = $sourceTask->replicate();
            $newTask->milestone_id = $milestone->id;
            $newTask->name = $sourceTask->name . ' (Imported)';
            $newTask->sort_order = ($milestone->tasks()->max('sort_order') ?? 0) + 1;
            $newTask->save();

            // Import subtasks
            foreach ($sourceTask->subtasks as $subtask) {
                $newSubtask = $subtask->replicate();
                $newSubtask->task_id = $newTask->id;
                $newSubtask->save();
            }

            return response()->json([
                'success' => true,
                'message' => 'Task imported successfully!',
                'task' => $newTask
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error importing task: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get tasks for template builder
     */
    public function getForBuilder(ProjectTemplate $projectTemplate, TemplateMilestone $milestone): JsonResponse
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $tasks = $milestone->tasks()
            ->with(['subtasks'])
            ->orderBy('sort_order')
            ->get()
            ->map(function($task) {
                return [
                    'id' => $task->id,
                    'name' => $task->name,
                    'description' => $task->description,
                    'estimated_hours' => $task->estimated_hours,
                    'hourly_rate' => $task->hourly_rate,
                    'fee_type' => $task->fee_type,
                    'days_from_start' => $task->days_from_start,
                    'duration_days' => $task->duration_days,
                    'sort_order' => $task->sort_order,
                    'subtasks_count' => $task->subtasks->count(),
                    'total_hours' => $task->estimated_hours + $task->subtasks->sum('estimated_hours')
                ];
            });

        return response()->json(['tasks' => $tasks]);
    }

    /**
     * Bulk operations on tasks
     */
    public function bulkAction(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only perform bulk actions on templates from your own company.');
        }

        $validated = $request->validate([
            'action' => 'required|in:delete,duplicate,update_fee_type,move',
            'task_ids' => 'required|array',
            'task_ids.*' => 'exists:template_tasks,id',
            'fee_type' => 'required_if:action,update_fee_type|in:in_fee,additional',
            'target_milestone_id' => 'required_if:action,move|exists:template_milestones,id'
        ]);

        $tasks = TemplateTask::whereIn('id', $validated['task_ids'])
            ->where('milestone_id', $milestone->id)
            ->get();

        $processedCount = 0;

        try {
            switch ($validated['action']) {
                case 'delete':
                    foreach ($tasks as $task) {
                        $task->delete();
                        $processedCount++;
                    }
                    break;

                case 'duplicate':
                    foreach ($tasks as $task) {
                        $newTask = $task->replicate();
                        $newTask->name = $task->name . ' (Copy)';
                        $newTask->sort_order = ($milestone->tasks()->max('sort_order') ?? 0) + 1;
                        $newTask->save();

                        // Duplicate subtasks
                        foreach ($task->subtasks as $subtask) {
                            $newSubtask = $subtask->replicate();
                            $newSubtask->task_id = $newTask->id;
                            $newSubtask->save();
                        }
                        $processedCount++;
                    }
                    break;

                case 'update_fee_type':
                    foreach ($tasks as $task) {
                        $task->update(['fee_type' => $validated['fee_type']]);
                        $processedCount++;
                    }
                    break;

                case 'move':
                    $targetMilestone = TemplateMilestone::where('id', $validated['target_milestone_id'])
                        ->where('template_id', $projectTemplate->id)
                        ->firstOrFail();

                    $maxSortOrder = $targetMilestone->tasks()->max('sort_order') ?? 0;

                    foreach ($tasks as $task) {
                        $task->update([
                            'milestone_id' => $targetMilestone->id,
                            'sort_order' => ++$maxSortOrder
                        ]);
                        $processedCount++;
                    }
                    break;
            }

            return response()->json([
                'success' => true,
                'message' => "Successfully processed {$processedCount} tasks",
                'processed_count' => $processedCount
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error processing bulk action: ' . $e->getMessage()
            ], 500);
        }
    }

    /**
     * Get effective hourly rate for task
     */
    public function getEffectiveRate(TemplateTask $task): float
    {
        // Priority: Task rate > Milestone rate > Template default > Company rate
        if ($task->hourly_rate) {
            return $task->hourly_rate;
        }

        if ($task->milestone->hourly_rate) {
            return $task->milestone->hourly_rate;
        }

        if ($task->milestone->template->hourly_rate) {
            return $task->milestone->template->hourly_rate;
        }

        return Auth::user()->company->default_hourly_rate ?? 75.00;
    }

    /**
     * Get task usage statistics
     */
    private function getTaskUsageCount(TemplateTask $task): int
    {
        // Count how many times this task type appears in actual projects
        // This would need to be implemented based on how template import works
        // For now, return 0 as placeholder
        return 0;
    }

    /**
     * Search tasks across templates
     */
    public function search(Request $request): JsonResponse
    {
        $user = Auth::user();
        $search = $request->input('q', '');
        
        $tasks = TemplateTask::whereHas('milestone.template', function($q) use ($user) {
            $q->where('company_id', $user->company_id)
              ->orWhere('is_public', true);
        })
            ->where(function($q) use ($search) {
                $q->where('name', 'like', "%{$search}%")
                  ->orWhere('description', 'like', "%{$search}%");
            })
            ->with(['milestone.template'])
            ->orderBy('name')
            ->limit(10)
            ->get();

        return response()->json([
            'tasks' => $tasks->map(function($task) {
                return [
                    'id' => $task->id,
                    'name' => $task->name,
                    'description' => $task->description,
                    'estimated_hours' => $task->estimated_hours,
                    'template_name' => $task->milestone->template->name,
                    'milestone_name' => $task->milestone->name
                ];
            })
        ]);
    }

    /**
     * Export task data
     */
    public function export(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): JsonResponse
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $task->load(['subtasks']);

        $exportData = [
            'task' => $task->toArray(),
            'subtasks' => $task->subtasks->toArray(),
            'exported_at' => now(),
            'exported_by' => Auth::user()->name
        ];

        return response()->json($exportData)
            ->header('Content-Disposition', 'attachment; filename="task_' . $task->id . '_export.json"');
    }
}d !== Auth::user()->company_id) {
            abort(403, 'You can only add tasks to templates from your own company.');
        }

        return view('templates.projects.milestones.tasks.create', compact('projectTemplate', 'milestone'));
    }

    /**
     * Store a newly created task
     */
    public function store(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only add tasks to templates from your own company.');
        }

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'description' => 'nullable|string',
            'estimated_hours' => 'nullable|numeric|min:0',
            'hourly_rate' => 'nullable|numeric|min:0',
            'fee_type' => 'required|in:in_fee,additional',
            'days_from_start' => 'nullable|integer|min:0',
            'duration_days' => 'nullable|integer|min:1',
            'default_start_date' => 'nullable|date',
            'default_end_date' => 'nullable|date|after_or_equal:default_start_date'
        ]);

        // Calculate sort order
        $maxSortOrder = $milestone->tasks()->max('sort_order') ?? 0;
        $validated['sort_order'] = $maxSortOrder + 1;

        $task = $milestone->tasks()->create($validated);

        return redirect()->route('project-templates.milestones.tasks.show', [$projectTemplate, $milestone, $task])
            ->with('success', 'Template task created successfully!');
    }

    /**
     * Display the specified task
     */
    public function show(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): View
    {
        // Check access
        if ($projectTemplate->company_id !== Auth::user()->company_id && !$projectTemplate->is_public) {
            abort(403, 'You do not have access to this template.');
        }

        $task->load(['subtasks']);

        // Calculate task statistics
        $stats = [
            'total_subtasks' => $task->subtasks()->count(),
            'total_estimated_hours' => $task->estimated_hours + $task->subtasks()->sum('estimated_hours'),
            'usage_count' => $this->getTaskUsageCount($task)
        ];

        return view('templates.projects.milestones.tasks.show', compact('projectTemplate', 'milestone', 'task', 'stats'));
    }

    /**
     * Show the form for editing the specified task
     */
    public function edit(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): View
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only edit tasks from templates in your own company.');
        }

        return view('templates.projects.milestones.tasks.edit', compact('projectTemplate', 'milestone', 'task'));
    }

    /**
     * Update the specified task
     */
    public function update(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only edit tasks from templates in your own company.');
        }

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'description' => 'nullable|string',
            'estimated_hours' => 'nullable|numeric|min:0',
            'hourly_rate' => 'nullable|numeric|min:0',
            'fee_type' => 'required|in:in_fee,additional',
            'days_from_start' => 'nullable|integer|min:0',
            'duration_days' => 'nullable|integer|min:1',
            'default_start_date' => 'nullable|date',
            'default_end_date' => 'nullable|date|after_or_equal:default_start_date'
        ]);

        $task->update($validated);

        return redirect()->route('project-templates.milestones.tasks.show', [$projectTemplate, $milestone, $task])
            ->with('success', 'Template task updated successfully!');
    }

    /**
     * Remove the specified task
     */
    public function destroy(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only delete tasks from templates in your own company.');
        }

        try {
            $task->delete();
            
            return redirect()->route('project-templates.milestones.tasks.index', [$projectTemplate, $milestone])
                ->with('success', 'Template task deleted successfully!');
                
        } catch (\Exception $e) {
            return redirect()->back()
                ->with('error', 'Error deleting task: ' . $e->getMessage());
        }
    }

    /**
     * Reorder tasks via drag & drop
     */
    public function reorder(Request $request, ProjectTemplate $projectTemplate, TemplateMilestone $milestone): JsonResponse
    {
        // Check permissions
        if ($projectTemplate->company_id !== Auth::user()->company_id) {
            abort(403, 'You can only reorder tasks in templates from your own company.');
        }

        $validated = $request->validate([
            'task_ids' => 'required|array',
            'task_ids.*' => 'exists:template_tasks,id'
        ]);

        foreach ($validated['task_ids'] as $index => $taskId) {
            TemplateTask::where('id', $taskId)
                ->where('milestone_id', $milestone->id)
                ->update(['sort_order' => $index + 1]);
        }

        return response()->json([
            'success' => true,
            'message' => 'Tasks reordered successfully!'
        ]);
    }

    /**
     * Duplicate a task
     */
    public function duplicate(ProjectTemplate $projectTemplate, TemplateMilestone $milestone, TemplateTask $task): RedirectResponse
    {
        // Check permissions
        if ($projectTemplate->company_i